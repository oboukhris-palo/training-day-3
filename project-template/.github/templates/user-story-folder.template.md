# User Story Folder Template

**Purpose**: This template defines the REQUIRED files for every user story folder under `/docs/user-stories/<US-REF>/`. Tech Lead creates these files upfront (skeleton stubs); agents populate them as they work.

---

## Folder Structure (Create Upfront)

```
/docs/user-stories/<US-REF>/
├── <US-REF>.md                          # Story definition + acceptance criteria (link to PRD version)
├── implementation-plan.md                # Concise layer-by-layer architecture (max 500 words/layer)
├── handoff.md                            # SINGLE handoff file (OVERWRITE each TDD phase)
├── tdd-execution.md                      # Append-only audit log (NEVER delete entries)
├── bdd-scenarios/                        # Copy of feature files for reference
│   ├── login.feature                     # Example: Copy of features/auth/login.feature
│   ├── subscription.feature              # Example: Copy of features/billing/subscription.feature
│   └── ...
└── [Optional: code-review-report.md]     # Generated by REFACTOR agent after Layer complete
```

---

## File Purposes & Lifecycle

### 1. **{US-REF}.md** (Story Definition)

**Created by**: Tech Lead (skeleton, links to PRD)  
**Updated by**: No one (read-only reference to PRD version)  
**Purpose**: Single source of truth for story definition  
**Content**: Link to `/docs/prd/user-stories/{US-REF}.md` + acceptance criteria

**Life Cycle**:
- Tech Lead creates stub with link
- Never modified (reference only)
- Points to canonical story in PRD

**Example**:
```markdown
# US-001: User Registration

**Source**: [/docs/prd/user-stories.md#US-001](/docs/prd/user-stories.md#US-001)

**Acceptance Criteria**:
1. User can register with email + password
2. System sends verification email within 60 seconds
3. Verification link expires after 24 hours

**BDD Scenarios**: See `bdd-scenarios/registration.feature`

**Acceptance**: See implementation-plan.md "Definition of Done"
```

---

### 2. **implementation-plan.md** (Architecture Breakdown)

**Created by**: Dev-Lead during Phase 2 (Sprint Planning)  
**Updated by**: No one (frozen once handed off)  
**Purpose**: Detailed layer-by-layer guide for TDD execution  
**Constraint**: **MAX 500 words per layer** (concise, actionable)

**Life Cycle**:
- Tech Lead writes concise plan with:
  - Layer 1-4 sections (each ≤500 words)
  - Files to create, BDD coverage, TDD approach, constraints
  - Definition of Done (cumulative)
- TDD agents reference during RED-GREEN-REFACTOR
- Stays frozen (no updates during execution)

**Example Structure**:
```markdown
# Implementation Plan: US-001 User Registration

## Header (100 words max)
- Story: US-001 User Registration
- Epic: Authentication (User Access Control)
- BDD Scenarios: features/auth/registration.feature (lines 5-45)
- Failing Tests: 3 scenarios needing implementation

**Key Timeline**: Layer 1 (2h) → Layer 2 (4h) → Layer 3 (1h) → Layer 4 (3h)

---

## Layer 1 - Database (500 words max)

**Goal**: Create users table with secure schema

**Files to Create**:
- Migration: `/src/db/migrations/001_create_users_table.ts`
- Model: `/src/models/User.ts`
- Test: `/src/models/__tests__/User.test.ts`

**BDD Test Coverage** (Which assertions pass after Layer 1):
- ✅ "User table stores email and password hash"
- ✅ "User email is unique (constraint prevents duplicates)"
- ✅ "User.id is UUID (not auto-increment)"

**TDD Approach**:
1. RED: Test User.create() with valid data → fails
2. GREEN: Implement migration + model
3. REFACTOR: Extract password hashing, add JSDoc

**Architectural Constraints**:
- Use Sequelize ORM (from architecture-design.md)
- Password must be bcrypt hash, never plaintext
- Email field unique at DB level
- ID field as UUID primary key

**Estimated Complexity**: 3 story points (2 hours)

---

## Layer 2 - Backend (500 words max)

**Goal**: Create POST /api/auth/register endpoint

**Files to Create**:
- Controller: `src/controllers/AuthController.ts`
- Service: `src/services/AuthService.ts`
- DTO: `src/dtos/RegisterRequest.ts`, `RegisterResponse.ts`
- Middleware: `src/middleware/ValidationMiddleware.ts`
- Test: `src/services/__tests__/AuthService.test.ts`

**BDD Test Coverage** (Assertions now passing):
- ✅ Previous Layer 1 assertions still passing
- ✅ "POST /api/auth/register returns 201 Created"
- ✅ "Response includes user object with ID and email"
- ✅ "Password never returned in response"
- ✅ "Duplicate email returns 409 Conflict"

**TDD Approach**:
1. RED: Integration test for POST /api/auth/register → fails
2. GREEN: Implement AuthService.register() + AuthController
3. REFACTOR: Extract validation, improve error messages

**Architectural Constraints**:
- JWT token generation (from tech-spec.md)
- bcrypt with 10 salt rounds (from security spec)
- Rate limiting: 5 attempts per hour per IP
- Email validation: RFC 5322 basic check

**Estimated Complexity**: 5 story points (4 hours)

---

## Layer 3 - Configuration (500 words max)

[Similar structure...]

---

## Layer 4 - Frontend (500 words max)

[Similar structure...]

---

## Implementation Sequence

1. Layer 1 (Database) MUST complete before Layer 2
2. Layer 2 (Backend) MUST complete before Layer 3
3. Layer 3 (Config) MUST complete before Layer 4
4. Layer 4 is independent (no blocking)

**Parallel Opportunities**: None for this story (sequential)

---

## Definition of Done (Cumulative)

- ✅ All BDD scenarios in `bdd-scenarios/` passing
- ✅ Test coverage > 80% (all layers)
- ✅ Cyclomatic complexity < 10 (all layers)
- ✅ Code review approved (13-point checklist)
- ✅ Zero critical security issues
- ✅ Performance targets met (all endpoints <500ms)
- ✅ Design system compliance (frontend components)
- ✅ Merged to main branch
```

**Word Count Enforcement**:
- Header: ~100 words
- Each Layer: ~400-500 words
- Sequence: ~100 words
- Total: ~2,000 words (concise, not verbose)

---

### 3. **handoff.md** (Cycle Status)

**Created by**: Tech Lead (skeleton)  
**Updated by**: TDD agents at end of each phase  
**Purpose**: Current cycle state for next agent  
**Lifecycle**: OVERWRITE after RED, GREEN, REFACTOR (NOT per-cycle files)

**Update Pattern**:
```
RED finishes → handoff.md shows: phase=RED_COMPLETE, next=GREEN
GREEN finishes → handoff.md OVERWRITES previous: phase=GREEN_COMPLETE, next=REFACTOR
REFACTOR finishes → handoff.md OVERWRITES: phase=REFACTOR_COMPLETE, next=NEXT_CYCLE or CODE_REVIEW
```

**Example Content**:
```markdown
# Handoff: US-001 TDD Cycle

**Cycle**: 5 | **Phase**: GREEN_COMPLETE
**Previous**: RED completed (test written for tier sync)
**Current**: GREEN completed (code passes test)
**Next**: REFACTOR (improve quality)
**Branch**: feature/auth-001

## Progress
- ✅ Test written: UserTierSyncService failing test (12 assertions)
- ✅ Code implemented: Service passes all assertions (45 LOC)
- ⏳ Refactoring: Extract utility, improve naming

## Files Modified
- src/services/UserTierSyncService.ts (new)
- src/models/User.ts (updated)

**Last Updated**: 2026-02-05 11:15 UTC

---
Committed: TDD-US-001-GREEN-5
See tdd-execution.md for full history.
```

---

### 4. **tdd-execution.md** (Audit Log)

**Created by**: Tech Lead (skeleton)  
**Updated by**: TDD agents append after each cycle phase  
**Purpose**: Complete, immutable audit trail  
**Lifecycle**: APPEND-ONLY (never delete, never overwrite)

**Append Pattern**:
```
Each TDD phase (RED, GREEN, REFACTOR) appends ONE entry:

## Cycle 5: RED Phase
- Time: 2026-02-05 10:30 UTC
- Outcome: ✅ Test fails
- Commit: TDD-US-001-RED-5

## Cycle 5: GREEN Phase
- Time: 2026-02-05 11:15 UTC
- Outcome: ✅ Tests passing
- Commit: TDD-US-001-GREEN-5

## Cycle 5: REFACTOR Phase
- Time: 2026-02-05 11:45 UTC
- Outcome: ✅ Improved code quality
- Commit: TDD-US-001-REFACTOR-5

[NEXT CYCLE APPENDS BELOW - existing entries stay intact]
```

---

### 5. **bdd-scenarios/** (Feature Files)

**Created by**: Dev-Lead during Phase 1 (BDD Integration)  
**Content**: Copies of feature files from `features/` directory  
**Purpose**: Reference for TDD agents; single source of truth is in `features/`

**Example**:
```
bdd-scenarios/
├── registration.feature         (Copy from features/auth/registration.feature)
├── email-verification.feature   (Copy from features/auth/email-verification.feature)
└── login.feature                (Copy from features/auth/login.feature)
```

---

### 6. **code-review-report.md** (Generated After Layer Complete)

**Created by**: REFACTOR agent after final REFACTOR phase for layer  
**Purpose**: Detailed code review against 13-point checklist (coding.instructions.md)

**Content**:
```markdown
# Code Review Report: US-001 Layer 2 (Backend)

## 13-Point Checklist

1. **SOLID Principles** ✅
   - Single Responsibility: Each class has one reason to change
   - Open/Closed: New validation rules extend without modifying existing code
   - Liskov Substitution: All implementations follow contract
   - Interface Segregation: Small, focused interfaces
   - Dependency Inversion: Depends on abstractions, not concretions

2. **Test Coverage** ✅ 94%
   - Happy path: User registration with valid data
   - Error paths: Duplicate email, invalid format
   - Edge cases: Empty fields, special characters

[... rest of 13 points ...]

## Issues Found

### Critical (0)
None

### High (0)
None

### Medium (1)
- Missing error logging in AuthService.register() → Recommend adding winston logger

### Low (2)
- JSDoc could be more detailed for DTO classes
- Consider extracting magic number (5 rate limit) to config constant

## Overall Assessment

**Status**: ✅ APPROVED FOR MERGE

**Summary**: Code quality is excellent. All SOLID principles followed. Test coverage 94% (exceeds 80% target). Complexity within limits (max 7, target <10). No critical or high issues. Ready for production.

**Approved By**: dev-tdd-refactor  
**Date**: 2026-02-05 12:00 UTC
```

---

## File Creation Checklist (Tech Lead)

Before handing off to TDD agents, Tech Lead ensures:

```
✅ Created folder: /docs/user-stories/<US-REF>/
✅ Created <US-REF>.md (link to PRD, acceptance criteria)
✅ Created implementation-plan.md (500 words/layer max)
✅ Created handoff.md (skeleton)
✅ Created tdd-execution.md (skeleton)
✅ Created bdd-scenarios/ folder
✅ Copied feature files to bdd-scenarios/
✅ All skeleton files ready for population
✅ implementation-plan.md references tech-spec.md constraints
✅ Folder structure matches this template exactly
```

---

## Key Rules for Agents

### Handoff.md Rules
- ✅ Update ONLY at end of each phase (RED complete, GREEN complete, REFACTOR complete)
- ✅ OVERWRITE previous content (not append)
- ✅ Keep under 300 words (concise)
- ✅ Include progress, next steps, notes for next agent
- ❌ Create cycle-specific versions (cycle-5-handoff.md, red-handoff.md)

### tdd-execution.md Rules
- ✅ APPEND new entries at top (most recent first)
- ✅ ONE entry per phase (RED, GREEN, REFACTOR)
- ✅ Commit message in entry: TDD-<US-REF>-<PHASE>-<CYCLE>
- ✅ Never delete or overwrite (immutable)
- ✅ Provide complete audit trail for stakeholders
- ❌ Create per-cycle files (no cycle-5-log.md)

### Git Commit Message Rules
```
TDD-<US-REF>-<PHASE>-<CYCLE>: [Description]

Examples:
- TDD-US-001-RED-5: Write failing test for tier sync
- TDD-US-001-GREEN-5: Implement UserTierSyncService.sync()
- TDD-US-001-REFACTOR-5: Extract tierSync utility
```

---

## Folder Lifecycle Example

### T=0 (Tech Lead - Phase 2, Sprint Planning)
```
Tech Lead creates:
/docs/user-stories/US-001/
├── US-001.md (stub: link to PRD)
├── implementation-plan.md (500 words per layer)
├── handoff.md (skeleton: awaiting RED phase)
├── tdd-execution.md (skeleton: empty)
└── bdd-scenarios/
    ├── registration.feature (copied from features/)
    └── email-verification.feature
```

### T=1h (RED Agent - Cycle 1, Layer 1)
```
RED agent:
1. Reads implementation-plan.md Layer 1
2. Writes failing test in UserRepository.test.ts
3. APPENDS entry to tdd-execution.md (Cycle 1: RED Phase)
4. OVERWRITES handoff.md (phase=RED_COMPLETE, next=GREEN)
5. Commits: TDD-US-001-RED-1: Write failing test...
```

### T=2h (GREEN Agent - Cycle 1, Layer 1)
```
GREEN agent:
1. Reads handoff.md (phase hints for GREEN)
2. Implements UserRepository.ts
3. APPENDS entry to tdd-execution.md (Cycle 1: GREEN Phase)
4. OVERWRITES handoff.md (phase=GREEN_COMPLETE, next=REFACTOR)
5. Commits: TDD-US-001-GREEN-1: Implement UserRepository...
```

### T=3h (REFACTOR Agent - Cycle 1, Layer 1)
```
REFACTOR agent:
1. Reads handoff.md (quality targets)
2. Refactors UserRepository.ts, extracts utility
3. APPENDS entry to tdd-execution.md (Cycle 1: REFACTOR Phase)
4. OVERWRITES handoff.md (phase=REFACTOR_COMPLETE, next=CYCLE_2_RED)
5. Generates code-review-report.md
6. Commits: TDD-US-001-REFACTOR-1: Extract password hashing...
```

### T=4h (RED Agent - Cycle 2, Layer 1)
```
RED agent starts new cycle:
1. Reads implementation-plan.md Layer 1 (next behavior)
2. Writes failing test for error handling
3. APPENDS to tdd-execution.md (Cycle 2: RED Phase)
4. OVERWRITES handoff.md (Cycle=2, phase=RED_COMPLETE)
5. Commits: TDD-US-001-RED-2: Test edge case...
[Continue: GREEN → REFACTOR]
```

### T=∞ (After All Layers Complete)
```
/docs/user-stories/US-001/
├── US-001.md (unchanged)
├── implementation-plan.md (unchanged)
├── handoff.md (final: Ready for merge)
├── tdd-execution.md (complete: 60+ entries, major audit trail)
├── code-review-report.md (generated by final REFACTOR)
└── bdd-scenarios/
    └── [unchanged]

tdd-execution.md contains:
- 4 layers × N cycles × 3 phases = Complete history
- BDD progress tracking
- Commits summary
- Decisions made
- Blockers resolved
- Ready for retrospective or audit
```

---

## Benefits of This Structure

| Aspect | Benefit |
|--------|---------|
| **Document Consolidation** | No sprawl: 1 handoff + 1 log instead of cycle-* files |
| **Auditability** | tdd-execution.md is complete audit trail (immutable) |
| **Clarity** | handoff.md always shows current cycle state (current snapshot) |
| **Stakeholder Visibility** | tdd-execution.md shows full journey; can generate summary report |
| **Git Simplicity** | Commit messages linked to handoff/execution entries |
| **Scalability** | Works for 1 story or 100 stories; structure is consistent |
| **Traceability** | Code → BDD scenario → Layer → Cycle → Commit → Entry in log |

---

## Summary

**Create Upfront (Tech Lead)**:
- ✅ Folder `/docs/user-stories/<US-REF>/`
- ✅ 5 files: {US-REF}.md, implementation-plan.md, handoff.md, tdd-execution.md, bdd-scenarios/

**Agents Populate During TDD**:
- OVERWRITE: handoff.md (after each phase)
- APPEND: tdd-execution.md (after each phase)
- GENERATE: code-review-report.md (after each layer REFACTOR)

**Never Create**:
- ❌ cycle-specific files (cycle-5-handoff.md, red-handoff.md)
- ❌ per-agent files (dev-tdd-red-notes.md, dev-tdd-green-notes.md)
- ❌ phase-specific logs (red-log.md, green-log.md, refactor-log.md)

**Result**: Clean, auditable, scalable structure with ZERO document sprawl.

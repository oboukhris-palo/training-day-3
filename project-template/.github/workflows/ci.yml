name: CI Quality & Tests

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch: {}

jobs:
  validate:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install ajv-cli and yq
        run: |
          npm i -g ajv-cli@5
          YQ_VER=v4.44.3
          curl -L "https://github.com/mikefarah/yq/releases/download/${YQ_VER}/yq_linux_amd64" -o /usr/local/bin/yq
          chmod +x /usr/local/bin/yq
      - name: Validate story.yaml files
        run: |
          shopt -s globstar || true
          rc=0
          for f in docs/user-stories/**/story.yaml; do
            [ -f "$f" ] || continue
            yq -o=json "$f" | ajv validate -s .github/schemas/story.schema.json -d /dev/stdin || rc=1
          done
          exit $rc
      - name: Validate delta_summary.json and decision_log.json
        run: |
          shopt -s globstar || true
          rc=0
          for f in docs/user-stories/**/delta_summary.json; do
            [ -f "$f" ] || continue
            ajv validate -s .github/schemas/delta_summary.schema.json -d "$f" || rc=1
          done
          for f in docs/user-stories/**/decision_log.json; do
            [ -f "$f" ] || continue
            ajv validate -s .github/schemas/decision_log.schema.json -d "$f" || rc=1
          done
          exit $rc
      - name: Enforce PR title and story reference consistency
        id: title
        run: |
          title='${{ github.event.pull_request.title }}'
          if [[ "$title" =~ \[US-[0-9]{3,}\] ]]; then
            ref=$(echo "$title" | sed -n 's/.*\(US-[0-9][0-9]*\).*/\1/p' | head -n1)
            echo "story_ref=$ref" >> $GITHUB_OUTPUT
          else
            echo "PR title must include [US-XXX]" >&2
            exit 1
          fi
      - name: Verify changed paths match story ref
        env:
          STORY_REF: ${{ steps.title.outputs.story_ref }}
        run: |
          base="${{ github.event.pull_request.base.sha }}"
          head="${{ github.event.pull_request.head.sha }}"
          files=$(git diff --name-only "$base" "$head")
          story_paths=$(echo "$files" | grep -E '^docs/user-stories/US-[0-9]+/' || true)
          if [ -n "$story_paths" ]; then
            mismatches=$(echo "$story_paths" | grep -v "/$STORY_REF/" || true)
            if [ -n "$mismatches" ]; then
              echo "Changed story folders do not match $STORY_REF:" >&2
              echo "$mismatches" >&2
              exit 1
            fi
          fi
          plan_paths=$(echo "$files" | grep -E '^docs/user-stories/US-[0-9]+/implementation-plan.md$' || true)
          if [ -n "$plan_paths" ]; then
            echo "$plan_paths" | grep "/$STORY_REF/implementation-plan.md$" >/dev/null || { echo "implementation-plan.md path must match $STORY_REF" >&2; exit 1; }
          fi
          if [ -f docs/user-stories/user-stories.md ]; then
            grep -q "$STORY_REF" docs/user-stories/user-stories.md || { echo "$STORY_REF not found in docs/user-stories/user-stories.md" >&2; exit 1; }
          fi
          if [ -f docs/prd/user-stories.md ]; then
            grep -q "$STORY_REF" docs/prd/user-stories.md || { echo "$STORY_REF not found in docs/prd/user-stories.md" >&2; exit 1; }
          fi

  test_impact:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Detect Node project
        id: detect
        run: |
          if [ -f package.json ]; then echo "node=true" >> $GITHUB_OUTPUT; else echo "node=false" >> $GITHUB_OUTPUT; fi
      - name: Setup Node
        if: steps.detect.outputs.node == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install deps
        if: steps.detect.outputs.node == 'true'
        run: npm ci --prefer-offline --no-audit --no-fund
      - name: Run impacted tests (heuristic)
        if: steps.detect.outputs.node == 'true'
        run: |
          base="${{ github.event.pull_request.base.sha }}"
          head="${{ github.event.pull_request.head.sha }}"
          files=$(git diff --name-only "$base" "$head" | tr '\n' ' ')
          echo "Changed: $files"
          if echo "$files" | grep -qE '(\.test\.|/tests/|/__tests__/|features/)'; then
            npm test -- --reporters=default || npm run test || true
          else
            echo "No test files changed; running smoke (if defined)"
            npm run -s test:smoke || echo "No smoke tests defined"
          fi

  mutation:
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Detect Node project
        id: detect
        run: |
          if [ -f package.json ]; then echo "node=true" >> $GITHUB_OUTPUT; else echo "node=false" >> $GITHUB_OUTPUT; fi
      - name: Setup Node
        if: steps.detect.outputs.node == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install deps
        if: steps.detect.outputs.node == 'true'
        run: npm ci --prefer-offline --no-audit --no-fund
      - name: Run mutation tests if configured
        if: steps.detect.outputs.node == 'true'
        run: |
          node -e "const p=require('./package.json');process.exit(p.devDependencies && (p.devDependencies['@stryker-mutator/core']||p.devDependencies['stryker'])?0:1)" \
          && (npm run mutation || npm run test:mutation) \
          || echo "Mutation testing not configured; skipping"
